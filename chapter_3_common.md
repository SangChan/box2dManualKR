
# Chapter 3 Common

# 3.1 About

Common 모듈은 설정, 메모리 관리, 벡터 계산을 포함합니다.


# 3.2 Settings
b2Settings.h 파일에는 다음의 내용이 포함되어 있습니다.

* int32나 float32 같은 타입
* 상수 (파이 등등..)
* 메모리 할당 관련 래퍼
* 버전

## Types
Box2D 는 float32, int 등과 같은 타입을 정의해 두고 있으며 이를 통해 구조체 정의를 쉽게 할 수 있습니다.

## Constants
몇 가지 상수가 정의되어 있습니다. b2Settings.h 파일을 참조하시기 바랍니다.
Box2D는 부동소수점 연산을 통해 충돌과 시뮬레이션을 실행합니다. 반올림에 의한 오류를 수정하기 위한 오차에 대한 부분이 설정되어 있으며, 일부는 절대적이기도 하고 일부는 상대적이기도 합니다. 절대 오차에 대해서는 MKS(Meter Kilogram Second) 단위를 사용합니다.

## Allocation wrappers
b2Alloc 과 b2Free 을 통해 대용량의 메모리 할당에 대한 부분을 정의하고 있습니다. 스스로 메모리 관리를 하기 위해서 사용할 수 있습니다.

## Version
b2Version 구조체는 현 런타임에서 사용하는 버전에 대한 정보를 저장하고 있습니다.

# 3.3 Memory Management
Box2D는 빠르고 효과적으로 메모리 관리를 할 수 있도록 설계되었습니다. 여기서는 Box2D 가 왜, 그리고 어떻게 메모리를 할당하는지 말하도록 하겠습니다.
Box2D는 50~300바이트 정도되는 작은 객체를 많이 할당합니다. 힙에 이러한 방식으로 malloc 이나 new 를 반복하는 것은 비효율적이고 조각이 발생할 수 있는 여지를 남깁니다. contact 같은 작은 객체를 짧은 생명주기를 가지고 있지만 몇 번의 시간 단계에서 여러 번 사용될 수도 있습니다. 그래서 이러한 메모리 사용을 위해 힙을 효율적으로 사용할 필요가 있습니다.

Box2D는 그래서 b2BlockAllocator 라는 SOA(작은 객체 할당자)를 사용해 해결하고자 합니다. SOA는 다양한 크기의 풀 (사이즈를 키울 수 있음)를 가지고 있습니다. 메모리 생성에 대한 요청이 오면, SOA는 가장 적당한 사이즈의 메모리 블럭을 제시합니다. 그리고 메모리 블럭의 사용에 해제되면, SOA의 풀로 반환됩니다. 이 과정은 매우 빠르고 힙의 소통에도 아주 조그마한 영향을 끼칠 뿐입니다.

BoX2D는 SOA를 사용하기 때문에 강체, fixture, joint 에 대해 메모리 할당을 할 필요가 없습니다. 하지만 b2World 에 대해서는 반드시 메모리 관리를 할 필요가 있습니다. 왜냐하면 b2World 객체는 강체, fixture, joint 를 생성하는 팩토리를 제공하기 때문입니다. SOA를 통해 사용자의 상세한 메모리 사용 내역을 감출 수 있으니, 반드시 강체, fixture, joint 에 대해 메모리 반환 명령을 내리지 마시기 바랍니다.

시간 단계를 실행함에 있어, 임시로 사용할 메모리가 필요합니다. b2StackAllocator 를 통해 스택을 할당하여, 그때마다 힙을 생성하지 않도록 합니다. 스택 할당자를 굳이 사용하고자 하지 않아도 되지만 이게 있다는 정도는 알아 두시는게 좋습니다.

# 3.4 Math
Box2D는 단순한 벡터 및 연산 모듈을 가지고 있으며 내재적인 목적에 맞게 사용하기 위해 설계되었습니다. 모두 공개되어 있으므로, 필요하다면 자유롭게 사용하시기 바랍니다.
수학 관련 라이브러리는 이식 및 유지 보수가 간단하도록 쉽고 단순하게 되어 있습니다.